name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.14"

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements_dev.txt

      # Mirrors pre-commit: pre-commit-hooks
      - name: Check trailing whitespace
        run: |
          git ls-files -z -- ':(exclude)*.pxd' | xargs -0 grep -Prl '\s+$' && \
            { echo '❌ Trailing whitespace found'; exit 1; } || \
            echo '✅ No trailing whitespace'

      - name: Check files end with newline
        run: |
          bad_files=$(git ls-files -z -- ':(exclude)*.pxd' | xargs -0 -I{} sh -c 'test -s "{}" && test "$(tail -c1 "{}")" && echo "{}"')
          if [ -n "$bad_files" ]; then
            echo "❌ Files missing final newline:"; echo "$bad_files"; exit 1
          fi
          echo '✅ All files end with newline'

      - name: Validate JSON/TOML
        run: |
          python3 << 'PYEOF'
          import json, pathlib, sys, tomllib
          errors = []
          for p in pathlib.Path('.').rglob('*.json'):
              try:
                  json.loads(p.read_text())
              except Exception as e:
                  errors.append(f'{p}: {e}')
          for p in pathlib.Path('.').rglob('*.toml'):
              try:
                  tomllib.loads(p.read_text())
              except Exception as e:
                  errors.append(f'{p}: {e}')
          if errors:
              print('Validation errors:')
              for e in errors:
                  print(e)
              sys.exit(1)
          print('All JSON/TOML valid')
          PYEOF

      - name: Check for merge conflicts
        run: |
          if git ls-files -z | xargs -0 grep -l '^<<<<<<< ' 2>/dev/null; then
            echo '❌ Merge conflict markers found'; exit 1
          fi
          echo '✅ No merge conflict markers'

      # Mirrors pre-commit: ruff (lint + format)
      - name: Ruff lint
        run: ruff check custom_components/ tests/

      - name: Ruff format check
        run: ruff format --check custom_components/ tests/

      # Mirrors pre-commit: pylint --rcfile=pyproject.toml
      - name: Pylint
        run: pylint --rcfile=pyproject.toml custom_components/omada_open_api/

  typecheck:
    name: Type Check (mypy strict)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements_dev.txt

      # Mirrors pre-commit: mypy --config-file=pyproject.toml
      - name: Mypy strict
        run: mypy --config-file pyproject.toml custom_components/omada_open_api/

  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements_dev.txt

      # Mirrors pre-commit: scripts/check_coverage.sh (pytest + coverage gate)
      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=custom_components.omada_open_api \
            --cov-report=term-missing \
            --cov-fail-under=$(cat .coverage-threshold) \
            -v

  validate:
    name: HACS & hassfest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration

      - name: hassfest validation
        uses: home-assistant/actions/hassfest@master
